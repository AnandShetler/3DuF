<!DOCTYPE html>
<html>
<head>
<!-- Load the Paper.js library -->
<script type="text/javascript" src="src/renderer/static/js/paper-full.min.js"></script>

<script type="text/javascript">
    paper.install(window);
    // Keep global references to both tools, so the HTML
    // links below can access them.
    var tool1, tool2;
    var start;
    var current_stroke;
    var width = 20;
    var cornerWidth = width/2;
    var gridSize = 20;
    var strokes = [];
    var strokeHistory = [];
    var forceSnap = true;
    var forceSharpCorners = true;
    var ctrl = false;

    var hitOptions = {
    stroke: true,
    ends: true,
    tolerance: 5
    };

    window.onload = function() {
        paper.setup('myCanvas');

        // Create two drawing tools.
        // tool1 will draw straight lines,
        // tool2 will draw clouds.

        // Both share the mouseDown event:

        function bake_cookie(name, value) {
          var cookie = [name, '=', JSON.stringify(value), '; domain=.', window.location.host.toString(),
           '; path=/;'].join('');
          document.cookie = cookie;
        }

        function read_cookie(name) {
             var result = document.cookie.match(new RegExp(name + '=([^;]+)'));
             result && (result = JSON.parse(result[1]));
             return result;
        }

        function loadStrokes(cookie){
            strokeHistory = read_cookie("strokeHistory");
            for (var stroke in strokeHistory){
                var c = makeChannel(new Point(stroke[0], stroke[1]), new Point(stroke[2], stroke[3]));
                strokes.push(c);
            }
        }

        function saveStrokes(cookie){
            bake_cookie("strokeHistory",strokeHistory);
        }

        function removeLastStroke(){
            var last;
            if (strokes.length > 1){
                last = strokes.pop();
                strokeHistory.pop();
            } else if (strokes.length ==1){
                last = strokes[0];
            }
            if (last){
                last.remove();
            }
        }

        function onKeyDown(event) {
            // When a key is pressed, set the content of the text item:
            if (event.key.charCodeAt(0) == 26){
                removeLastStroke();
                console.log("removing stroke");
            }
        }

        function onMouseMove(event){
            selectStroke(event);
            var res = project.hitTest(event.point, hitOptions);
            if (res && event.modifiers.shift){
                console.log(res);
            } 
        }

        function onMouseDown(event) {
            start = event.point;
            if (event.modifiers.control || forceSharpCorners){
                start = snapToGrid(start, gridSize);
            }
            if (current_stroke){
                current_stroke.selected = false;
                current_stroke = null;
            }
        }

        tool1 = new Tool();
        tool1.onMouseDown = onMouseDown;
        tool1.onKeyDown = onKeyDown;
        tool1.onMouseMove = onMouseMove;

        function selectStroke(event){
            project.activeLayer.selected = false;
            if (event.item){
                event.item.selected = true;
            }
        }

        tool1.onMouseDrag = function(event) {
            clearStroke();
            var target = event.point;
            
            if (event.modifiers.control || forceSnap){
                target = snapToGrid(target, gridSize);
            }
            if (event.modifiers.shift || forceSharpCorners){
                target = snapXY(start, target);
            } 
            current_stroke = makeChannel(start, target);
            current_stroke.selected = true;
        }

        tool1.onMouseUp = function(event){
            strokes.push(current_stroke);
            strokeHistory.push([current_stroke.start.x, current_stroke.start.y, current_stroke.end.x, current_stroke.end.y]);
            current_stroke.selected = false;
        }

        var clearStroke = function(){
            if (current_stroke){
                current_stroke.remove();
            }
        }

        var makeChannel = function(start, end){
            var s = makeHollowLine(start, end, width);
            var c1 = new Path.Circle(start, cornerWidth);
            c1.fillColor = 'black';
            var c2 = new Path.Circle(end, cornerWidth);
            c2.fillColor = 'black';
            var g = new Group([s,c1,c2]);
            g.start = start;
            g.end = end;
            return g;
            }

        var snapToGrid = function(target, gridSize){
            var newTarget = new Point();
            newTarget.x = Math.round(target.x / gridSize) * gridSize;
            newTarget.y = Math.round(target.y / gridSize) * gridSize;
            return newTarget;
        }

        var makeHollowLine = function(start, end){
            var l1 = makeLine(start, end, width);
            var l2 = makeLine(start, end, width/2);
            return new CompoundPath({
                children: [l1, l2],
                fillColor: 'black'
            });
        }

        var makeLine = function(start, end, thickness){
            /*
            var l = new Path.Line(start, end);
            l.strokeColor = 'black';
            l.strokeWidth = width;
            return l;
            */
            var vec = end.subtract(start);
            var rec = new Path.Rectangle({
                size: [vec.length, thickness],
                point: start,
                fillColor: 'black'
            });
            rec.translate([0,-thickness/2]);
            rec.rotate(vec.angle, start);
            return rec;

        }
    }   

        var snapXY = function(start, end){
            var vec = start.subtract(end);
            if (Math.abs(vec.x) > Math.abs(vec.y)){
                vec.y = 0;
            } else {
                vec.x = 0;
            }
            return start.subtract(vec);
        }
</script>
</head>
<body>
    <canvas id="myCanvas" resize></canvas>
</body>

<script type="text/javascript">
      var canvas = document.getElementById('myCanvas'),
            context = canvas.getContext('2d');

    // resize the canvas to fill browser window dynamically
    window.addEventListener('resize', resizeCanvas, false);

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resizeCanvas();
</script>
</html>